<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0f172a" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <title>Fitness App - Bağlantı</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main class="container">
      <section class="auth-card">
        <h1 class="app-title">
          <span class="icon">⚡</span>
          <span class="title-text">PowerFlow</span>
        </h1>
        <p class="subtitle">Lütfen bekleyin</p>
        <p id="msg" class="message"></p>
        <p id="dbg" class="message" style="display: none"></p>
      </section>
    </main>
    <script src="config.js"></script>
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
      const m = document.getElementById("msg");
      const d = document.getElementById("dbg");
      const setMsg = (t) => {
        if (m) m.textContent = t || "";
      };
      const log = (t) => {
        try {
          console.log("[callback]", t);
          if (d) {
            d.textContent = String(t);
          }
        } catch {}
      };
      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        setMsg("Yapılandırma eksik.");
      } else {
        const client = createClient(
          window.SUPABASE_URL,
          window.SUPABASE_ANON_KEY
        );
        (async () => {
          try {
            const params = new URLSearchParams(window.location.search);
            const code = params.get("code");
            const hash = new URLSearchParams(
              window.location.hash.replace(/^#/, "")
            );
            const access_token = hash.get("access_token");
            const refresh_token = hash.get("refresh_token");
            log(
              "code=" +
                code +
                " access_token=" +
                (access_token ? "[present]" : "-")
            );
            if (code) {
              const { error } = await client.auth.exchangeCodeForSession(code);
              if (error) {
                setMsg("Oturum kurulamadı: " + error.message);
                log(error.message);
              }
            } else if (access_token) {
              const { error } = await client.auth.setSession({
                access_token,
                refresh_token,
              });
              if (error) {
                setMsg("Oturum kurulamadı: " + error.message);
                log(error.message);
              }
            }
          } catch (e) {
            setMsg("Hata: " + (e?.message || e));
            log(e?.message || e);
          }
          const origin = window.location.origin;
          const base = window.location.pathname.replace(/[^/]+$/, "");
          log("redirect -> " + origin + base + "dashboard.html");
          // Fallback: if session check fails, still redirect to dashboard
          try {
            const { data: userData } = await client.auth.getUser();
            if (!userData || !userData.user) {
              log("No user session, redirecting anyway...");
            }
          } catch (e) {
            log("Session check failed: " + e?.message);
          }
          // Always redirect to dashboard, let it handle auth state
          window.location.replace(origin + base + "dashboard.html");
        })();
        // Safety timeout: if anything fails, redirect after 3 seconds
        setTimeout(() => {
          const origin = window.location.origin;
          const base = window.location.pathname.replace(/[^/]+$/, "");
          log("Safety timeout redirect");
          window.location.replace(origin + base + "dashboard.html");
        }, 3000);
      }
    </script>
  </body>
</html>
