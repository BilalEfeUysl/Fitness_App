<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0f172a" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <title>Fitness App - KayÄ±t Ol</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main class="container">
      <section class="auth-card">
        <h1 class="app-title">
          <span class="icon">âš¡</span>
          <span class="title-text">PowerFlow</span>
        </h1>
        <p class="subtitle">
          ðŸš€ <span class="highlight">Yeni hesap oluÅŸturun</span>
        </p>

        <form id="signUpForm" class="form" aria-label="KayÄ±t formu">
          <label for="signUpEmail">E-posta</label>
          <input
            id="signUpEmail"
            name="signUpEmail"
            type="email"
            required
            placeholder="Ã¶rnek@mail.com"
            autocomplete="email"
          />

          <label for="signUpPassword">Åžifre</label>
          <input
            id="signUpPassword"
            name="signUpPassword"
            type="password"
            required
            placeholder="En az 6 karakter"
            autocomplete="new-password"
          />

          <label for="signUpPasswordConfirm">Åžifre Onaylama</label>
          <input
            id="signUpPasswordConfirm"
            name="signUpPasswordConfirm"
            type="password"
            required
            placeholder="Åžifrenizi tekrar girin"
            autocomplete="new-password"
          />
          <div id="passwordError" class="error-message hidden"></div>

          <button type="submit" class="btn primary">HesabÄ±mÄ± oluÅŸtur</button>
        </form>

        <div class="divider"><span>HesabÄ±n var mÄ±?</span></div>
        <a href="./index.html" class="btn block">GiriÅŸe DÃ¶n</a>
      </section>
    </main>
    <div id="toast-container"></div>
    <script src="config.js"></script>
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      // Toast bildirim fonksiyonunu buraya da ekliyoruz
      function showToast(message, type = "success", duration = 4000) {
        const container = document.getElementById("toast-container");
        if (!container) return;
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;

        container.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("hiding");
          toast.addEventListener("animationend", () => {
            toast.remove();
          });
        }, duration);
      }

      // Eski setMessage fonksiyonu silindi.

      if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
        showToast("Supabase yapÄ±landÄ±rmasÄ± eksik.", "error");
      } else {
        const client = createClient(
          window.SUPABASE_URL,
          window.SUPABASE_ANON_KEY
        );
        const form = document.getElementById("signUpForm");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = document.getElementById("signUpEmail").value.trim();
          const password = document.getElementById("signUpPassword").value;
          const confirmPassword = document.getElementById(
            "signUpPasswordConfirm"
          ).value;
          const passwordErrorEl = document.getElementById("passwordError");

          if (password !== confirmPassword) {
            passwordErrorEl.textContent = "Åžifreler eÅŸleÅŸmiyor.";
            passwordErrorEl.classList.remove("hidden");
            return;
          }
          passwordErrorEl.classList.add("hidden");

          const submitButton = form.querySelector('button[type="submit"]');
          submitButton.disabled = true; // Butonu kilitle

          // Sadece e-posta ve ÅŸifre ile kayÄ±t
          const { error } = await client.auth.signUp({
            email,
            password,
          });

          if (error) {
            if (error.message.includes("User already registered")) {
              showToast(
                "Bu e-posta adresi zaten kayÄ±tlÄ±. LÃ¼tfen giriÅŸ yapÄ±n.",
                "error"
              );
            } else {
              showToast("KayÄ±t hatasÄ±: " + error.message, "error");
            }
            submitButton.disabled = false; // Hata durumunda butonu aÃ§
            return;
          }

          // BaÅŸarÄ±lÄ± kayÄ±t sonrasÄ± login sayfasÄ±na bilgi ile dÃ¶n
          const params = new URLSearchParams({ notice: "verify" });
          window.location.href = "index.html?" + params.toString();
        });

        // Åžifre eÅŸleÅŸme kontrolÃ¼ (bu kÄ±sÄ±m aynÄ± kaldÄ±)
        const passwordInput = document.getElementById("signUpPassword");
        const confirmPasswordInput = document.getElementById(
          "signUpPasswordConfirm"
        );
        const passwordErrorEl = document.getElementById("passwordError");

        function checkPasswords() {
          if (
            confirmPasswordInput.value &&
            passwordInput.value !== confirmPasswordInput.value
          ) {
            passwordErrorEl.textContent = "Åžifreler eÅŸleÅŸmiyor.";
            passwordErrorEl.classList.remove("hidden");
          } else {
            passwordErrorEl.classList.add("hidden");
          }
        }
        passwordInput.addEventListener("input", checkPasswords);
        confirmPasswordInput.addEventListener("input", checkPasswords);
      }
    </script>
  </body>
</html>
